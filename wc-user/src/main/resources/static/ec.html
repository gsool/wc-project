<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"> 
	<title>秒杀DEMO功能后端调试</title>
	<script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
</head>
<script type="text/javascript">

	var SUCCESS_00001 = "SUCCESS_00001";

	$(document).ready(function() {
		// 缓存表格头HTML
		goodsTableHeadHtml = $("#goodsTableHead").html();
		seckillTableHeadHtml = $("#seckillTableHead").html();
		seckillRedisTableHeadHtml = $("#seckillRedisTableHead").html();
		
		/* 初始化数据 */
		// 查询商品列表
		queryGoodsList();
		// 查询秒杀数据
		getSeckillList();
		// 查询秒杀Redis数据
		getSeckillRedisDisplayVo();
		
	});
	
	// 查询商品列表
	function queryGoodsList() {
		$.ajax({
			url : "/ec/goods/getList",
			contentType : "application/x-www-form-urlencoded",
			dataType : "json",
			success : function(data) {
				/* 错误信息提示与数据处理 */
				if (!data || data.code != SUCCESS_00001) {
					if (data && data.msg) {
						alert(data.msg);
						return;
					}
					alert("系统异常");
					return;
				}
				data = data.data;
				
				$("#goodsTable").html('');
				$("#goodsTable").append(goodsTableHeadHtml);
				
				if (!data) {
					return;
				}
				
				var html = "";
				for (var i = 0; i < data.length; i++) {
					html = html + "<tr>";
					html = html + "<td>" + data[i].id + "</td>";
					html = html + "<td>" + data[i].name + "</td>";
					html = html + "<td>" + data[i].description + "</td>";
					html = html + "</tr>";
				}
				
				$("#goodsTable").append(html);
			}
		});
	}
	
	// 查询
	function addSeckill() {
		var url = "/ec/seckill/add?goodsId=" + $("#goodsId").val() + "&goodsNum=" + $("#goodsNum").val();
		
		$.ajax({
			url : url,
			contentType : "application/x-www-form-urlencoded",
			dataType : "json",
			success : function(data) {
				getSeckillList();
			}
		});
	}
	
	// 查询秒杀数据
	function getSeckillList() {
		var url = "/ec/seckill/getList";
		
		$.ajax({
			url : url,
			contentType : "application/x-www-form-urlencoded",
			dataType : "json",
			success : function(data) {
				/* 错误信息提示与数据处理 */
				if (!data || data.code != SUCCESS_00001) {
					if (data && data.msg) {
						alert(data.msg);
						return;
					}
					alert("系统异常");
					return;
				}
				data = data.data;
				
				$("#seckillTable").html('');
				$("#seckillTable").append(seckillTableHeadHtml);
				
				if (!data) {
					return;
				}
				
				var html = "";
				for (var i = 0; i < data.length; i++) {
					html = html + "<tr>";
					html = html + "<td>" + data[i].seckillId + "</td>";
					html = html + "<td>" + data[i].goodsName + "</td>";
					html = html + "<td>" + data[i].num + "</td>";
					html = html + "<td>" + data[i].startTime + "</td>";
					html = html + "<td>" + data[i].endTime + "</td>";
					html = html + "<td><button type='button' onclick='deleteSeckill(" + data[i].seckillId + ")''>删除</button></td>";
					html = html + "</tr>";
				}
				
				$("#seckillTable").append(html);
			}
		});
	}
	
	// 查询秒杀Redis数据
	function getSeckillRedisDisplayVo() {
		var url = "/ec/seckill/getSeckillRedisDisplayVo";
		
		$.ajax({
			url : url,
			contentType : "application/x-www-form-urlencoded",
			dataType : "json",
			success : function(data) {
				/* 错误信息提示与数据处理 */
				if (!data || data.code != SUCCESS_00001) {
					if (data && data.msg) {
						alert(data.msg);
						return;
					}
					alert("系统异常");
					return;
				}
				data = data.data;
				
				$("#seckillRedisTable").html('');
				$("#seckillRedisTable").append(seckillRedisTableHeadHtml);
				
				if (!data) {
					return;
				}
				
				var html = "";
				for (var i = 0; i < data.length; i++) {
					html = html + "<tr>";
					html = html + "<td>" + data[i].key + "</td>";
					html = html + "<td>" + data[i].value + "</td>";
					html = html + "</tr>";
				}
				
				$("#seckillRedisTable").append(html);
			}
		});
	}
	
	// 删除秒杀
	function deleteSeckill(id) {
		var url = "/ec/seckill/deleteById?id=" + id;
		
		$.ajax({
			url : url,
			
			contentType : "application/x-www-form-urlencoded",
			dataType : "json",
			success : function(data) {
				/* 错误信息提示与数据处理 */
				if (!data || data.code != SUCCESS_00001) {
					if (data && data.msg) {
						alert(data.msg);
						return;
					}
					alert("系统异常");
					return;
				}
				data = data.data;
				
				getSeckillList();
			}
		});
	}
	
	// 同步秒杀到Redis
	function syncToRedis() {
		var url = "/ec/seckill/syncToRedis";
		
		$.ajax({
			url : url,
			
			contentType : "application/x-www-form-urlencoded",
			dataType : "json",
			success : function(data) {
				/* 错误信息提示与数据处理 */
				if (!data || data.code != SUCCESS_00001) {
					
					// 重新同步数据库
					syncToRedis();
					
					if (data && data.msg) {
						alert(data.msg);
						return;
					}
					alert("系统异常");
					return;
				}
				data = data.data;
				
				getSeckillList();
			}
		});
	}
	
	// 抢购
	function buy() {
		var url = "/ec/seckill/buy?goodsId=" + $("#buyGoodsId").val() + "&goodsNum=" + $("#buyGoodsNum").val();
		
		$.ajax({
			url : url,
			
			contentType : "application/x-www-form-urlencoded",
			dataType : "json",
			success : function(data) {
				/* 错误信息提示与数据处理 */
				if (!data || data.code != SUCCESS_00001) {
					if (data && data.msg) {
						alert(data.msg);
						return;
					}
					alert("系统异常");
					return;
				}
				data = data.data;
				
				getSeckillList();
			}
		});
	}

</script>
<body>

<button type="button" onclick="queryGoodsList()">查询商品列表</button><br/>
<table border="1" id="goodsTable">
  <tr id="goodsTableHead">
    <th>id</th>
    <th>商品名</th>
    <th>描述</th>
  </tr>
</table>

<br/>
======
<br/>

商品：<input type="text" value="10000" id="goodsId"/>&nbsp;&nbsp;&nbsp;数量：<input type="text" id="goodsNum"/><br/>
<button type="button" onclick="addSeckill();">加入秒杀活动（为了演示效果，加入后5秒后活动开始）</button><br/>
<button type="button" onclick="getSeckillList();">刷新列表</button><br/>
<button type="button" onclick="syncToRedis();">同步秒杀数据到Redis</button><br/>
<table border="1" id="seckillTable">
  <tr id="seckillTableHead">
    <th>秒杀活动ID</th>
    <th>商品名</th>
    <th>数量</th>
    <th>开始时间</th>
    <th>结束时间</th>
    <th>操作</th>
  </tr>
</table>

<br/>
======
<br/>

<button type="button" onclick="getSeckillRedisDisplayVo();">查询Redis数据</button><br/>
<table border="1" id="seckillRedisTable">
  <tr id="seckillRedisTableHead">
    <th>键</th>
    <th>值</th>
  </tr>
</table>

<br/>
======
<br/>

抢购商品：
商品：<input type="text" value="10000" id="buyGoodsId"/>&nbsp;&nbsp;&nbsp;数量：<input type="text" id="buyGoodsNum"/><br/>
<button type="button" onclick="buy();">抢购</button><br/>


快速链接：<br/>
<a href="./console.html">返回Console主页</a>

</body>
</html>